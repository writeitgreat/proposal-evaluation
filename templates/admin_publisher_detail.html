{% extends "base.html" %}
{% block title %}{{ publisher.name }} - Publishers - Write It Great{% endblock %}
{% block content %}

<section class="proposal-header">
    <div class="container">
        <h1>{{ publisher.name }}</h1>
        <div class="proposal-meta">
            <span>{{ publisher.email }}</span>
            {% if publisher.company %}<span>{{ publisher.company }}</span>{% endif %}
            <span>Joined {{ publisher.created_at.strftime('%B %d, %Y') if publisher.created_at else 'N/A' }}</span>
            {% if not publisher.is_approved %}
                <span class="status-badge on_hold">Pending Approval</span>
            {% elif publisher.is_active_account %}
                <span class="status-badge offer_received">Active</span>
            {% else %}
                <span class="status-badge declined">Deactivated</span>
            {% endif %}
        </div>
    </div>
</section>

<div class="container">
    <div class="detail-grid">
        {# ── Left Column: Profile & Proposal History ── #}
        <div>
            {# Profile #}
            <div class="detail-section">
                <h3>Profile</h3>

                {% if publisher.bio %}
                <p style="line-height: 1.6; color: var(--gray-700); margin-bottom: 1rem;">{{ publisher.bio }}</p>
                {% endif %}

                {% if publisher.website %}
                <div style="margin-bottom: 1rem;">
                    <span style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--gray-400); font-weight: 600;">Website</span>
                    <div><a href="{{ publisher.website }}" target="_blank" style="color: var(--primary); font-size: 0.875rem;">{{ publisher.website }}</a></div>
                </div>
                {% endif %}

                {% if stored_genres %}
                <div style="margin-bottom: 1rem;">
                    <span style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--gray-400); font-weight: 600; display: block; margin-bottom: 0.5rem;">Preferred Genres</span>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.375rem;">
                        {% for g in stored_genres %}
                        <span style="display: inline-block; padding: 0.25rem 0.75rem; background: var(--gray-100); border-radius: 12px; font-size: 0.8125rem; color: var(--gray-700);">{{ g }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if publisher.preferred_topics %}
                <div style="margin-bottom: 0;">
                    <span style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--gray-400); font-weight: 600; display: block; margin-bottom: 0.375rem;">Topics & Interests</span>
                    <p style="font-size: 0.875rem; color: var(--gray-700); line-height: 1.6;">{{ publisher.preferred_topics }}</p>
                </div>
                {% endif %}

                {% if not publisher.bio and not stored_genres and not publisher.preferred_topics and not publisher.website %}
                <p style="color: var(--gray-400); font-size: 0.875rem; text-align: center; padding: 1rem 0;">This publisher hasn't set up their profile yet.</p>
                {% endif %}
            </div>

            {# Shared Proposal History #}
            <div class="detail-section">
                <h3>Shared Proposals ({{ shared_proposals|length }})</h3>
                {% if shared_proposals %}
                <div style="margin: 0 -0.25rem;">
                    {% for sp in shared_proposals %}
                    {% set p = sp.proposal %}
                    <a href="{{ url_for('admin_proposal_detail', submission_id=p.submission_id) }}" style="display: block; padding: 0.75rem; margin-bottom: 0.5rem; border-radius: var(--radius); text-decoration: none; color: inherit; transition: background 0.15s; border: 1px solid var(--gray-100);"
                       onmouseover="this.style.background='var(--gray-50)'" onmouseout="this.style.background='transparent'">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 0.75rem;">
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: 600; font-size: 0.875rem; color: var(--primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ p.book_title }}</div>
                                <div style="font-size: 0.75rem; color: var(--gray-500); margin-top: 0.125rem;">
                                    by {{ p.author_name }} &middot; Shared {{ sp.shared_at.strftime('%b %d, %Y') }}{% if sp.shared_by %} by {{ sp.shared_by }}{% endif %}
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem; flex-shrink: 0;">
                                {% if sp.publisher_status and sp.publisher_status != 'new' %}
                                <span class="status-badge publisher-status-{{ sp.publisher_status }}" style="font-size: 0.6875rem;">{{ publisher_status_labels.get(sp.publisher_status, sp.publisher_status|replace('_', ' ')|title) }}</span>
                                {% endif %}
                                {% if p.tier %}
                                <span class="tier-badge tier-{{ p.tier|lower }}" style="font-size: 0.6875rem;">{{ p.tier }}</span>
                                {% endif %}
                                {% if p.overall_score is not none %}
                                <span style="font-weight: 700; font-size: 0.8125rem; color: var(--primary);">{{ p.overall_score|round|int }}</span>
                                {% endif %}
                            </div>
                        </div>
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <p style="color: var(--gray-400); font-size: 0.875rem; text-align: center; padding: 1rem 0;">No proposals have been shared with this publisher yet.</p>
                {% endif %}
            </div>
        </div>

        {# ── Right Column: Actions ── #}
        <div>
            <div class="detail-section">
                <h3>Account</h3>
                <div style="display: grid; gap: 0.5rem;">
                    {% if not publisher.is_approved %}
                    <form method="POST" action="{{ url_for('admin_approve_publisher', publisher_id=publisher.id) }}">
                        <button type="submit" class="btn btn-primary" style="width: 100%;">Approve Account</button>
                    </form>
                    {% endif %}

                    {% if publisher.is_active_account %}
                    <form method="POST" action="{{ url_for('admin_toggle_publisher_active', publisher_id=publisher.id) }}">
                        <button type="submit" class="btn btn-outline" style="width: 100%;">Deactivate Account</button>
                    </form>
                    {% else %}
                    <form method="POST" action="{{ url_for('admin_toggle_publisher_active', publisher_id=publisher.id) }}">
                        <button type="submit" class="btn btn-primary" style="width: 100%;">Reactivate Account</button>
                    </form>
                    {% endif %}

                    <form method="POST" action="{{ url_for('admin_delete_publisher', publisher_id=publisher.id) }}"
                          onsubmit="return confirm('Permanently delete {{ publisher.name }}? This will also remove all their shared proposal access.');">
                        <button type="submit" class="btn btn-outline" style="width: 100%; color: var(--error); border-color: var(--error);">Delete Account</button>
                    </form>
                </div>
            </div>

            <div class="detail-section">
                <h3>Contact Info</h3>
                <div style="font-size: 0.875rem; line-height: 2;">
                    <div><strong>Email:</strong> <a href="mailto:{{ publisher.email }}" style="color: var(--primary);">{{ publisher.email }}</a></div>
                    {% if publisher.company %}<div><strong>Company:</strong> {{ publisher.company }}</div>{% endif %}
                    {% if publisher.website %}<div><strong>Website:</strong> <a href="{{ publisher.website }}" target="_blank" style="color: var(--primary);">{{ publisher.website }}</a></div>{% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
