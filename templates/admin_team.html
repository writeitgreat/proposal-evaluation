{% extends "base.html" %}
{% block title %}Team Management - Write It Great{% endblock %}
{% block content %}
<section class="dashboard-header">
    <div class="container">
        <h1>Team Management</h1>
        <p>Manage team member accounts, roles, and security settings.</p>
        <div class="stats-grid">
            <div class="stat-card"><div class="stat-number">{{ members|length }}</div><div class="stat-label">Total Members</div></div>
            <div class="stat-card"><div class="stat-number">{{ members|selectattr('role', 'equalto', 'admin')|list|length }}</div><div class="stat-label">Admins</div></div>
            <div class="stat-card"><div class="stat-number">{{ members|selectattr('is_active_account')|list|length }}</div><div class="stat-label">Active</div></div>
            <div class="stat-card"><div class="stat-number">{{ members|selectattr('totp_enabled')|list|length }}</div><div class="stat-label">2FA Enabled</div></div>
        </div>
    </div>
</section>

<div class="container" style="padding: 0;">
    <table class="proposals-table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Role</th>
                <th>Status</th>
                <th>2FA</th>
                <th>Joined</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for member in members %}
            <tr {% if not member.is_active_account %}style="opacity: 0.5;"{% endif %}>
                <td>
                    <div class="author-name">{{ member.name }}</div>
                    {% if member.id == current_user.id %}<span style="font-size: 0.7rem; color: var(--accent-dark); font-weight: 600;">YOU</span>{% endif %}
                </td>
                <td><span class="author-email" style="font-size: 0.8125rem;">{{ member.email }}</span></td>
                <td>
                    {% if member.id == current_user.id %}
                        <span class="tier-badge tier-a" style="font-size: 0.75rem;">{{ member.role|title }}</span>
                    {% else %}
                        <form method="POST" action="{{ url_for('admin_update_role', user_id=member.id) }}" style="display: inline;">
                            <select name="role" onchange="this.form.submit()" style="padding: 0.25rem 0.5rem; border: 1px solid var(--gray-300); border-radius: 4px; font-size: 0.8125rem;">
                                {% for value, label in role_choices %}
                                <option value="{{ value }}" {% if member.role == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </form>
                    {% endif %}
                </td>
                <td>
                    {% if member.is_locked() %}
                        <span class="status-badge declined">Locked</span>
                    {% elif member.is_active_account %}
                        <span class="status-badge offer_received">Active</span>
                    {% else %}
                        <span class="status-badge on_hold">Deactivated</span>
                    {% endif %}
                </td>
                <td>
                    {% if member.totp_enabled %}
                        <span style="color: var(--success); font-weight: 600; font-size: 0.8125rem;">Enabled</span>
                    {% else %}
                        <span style="color: var(--warning); font-size: 0.8125rem;">Not set up</span>
                    {% endif %}
                </td>
                <td><span class="submitted-date">{{ member.created_at.strftime('%b %d, %Y') if member.created_at else 'N/A' }}</span></td>
                <td>
                    {% if member.id != current_user.id %}
                    <div style="display: flex; gap: 0.25rem; flex-wrap: wrap;">
                        {% if member.is_active_account %}
                        <form method="POST" action="{{ url_for('admin_toggle_active', user_id=member.id) }}" style="display: inline;">
                            <button type="submit" class="btn-action btn-action-warn" title="Deactivate account">Deactivate</button>
                        </form>
                        {% else %}
                        <form method="POST" action="{{ url_for('admin_toggle_active', user_id=member.id) }}" style="display: inline;">
                            <button type="submit" class="btn-action btn-action-success" title="Reactivate account">Activate</button>
                        </form>
                        {% endif %}

                        {% if member.is_locked() %}
                        <form method="POST" action="{{ url_for('admin_unlock_account', user_id=member.id) }}" style="display: inline;">
                            <button type="submit" class="btn-action btn-action-info" title="Unlock account">Unlock</button>
                        </form>
                        {% endif %}

                        {% if member.totp_enabled %}
                        <form method="POST" action="{{ url_for('admin_reset_2fa', user_id=member.id) }}" style="display: inline;"
                              onsubmit="return confirm('Reset 2FA for {{ member.name }}? They will need to set it up again.');">
                            <button type="submit" class="btn-action btn-action-info" title="Reset 2FA">Reset 2FA</button>
                        </form>
                        {% endif %}

                        <form method="POST" action="{{ url_for('admin_delete_member', user_id=member.id) }}" style="display: inline;"
                              onsubmit="return confirm('Permanently delete {{ member.name }}? This cannot be undone.');">
                            <button type="submit" class="btn-action btn-action-danger" title="Delete account">Delete</button>
                        </form>
                    </div>
                    {% else %}
                    <span style="font-size: 0.75rem; color: var(--gray-400);">â€”</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
