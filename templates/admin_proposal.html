{% extends "base.html" %}
{% block title %}{{ proposal.book_title }} - Admin{% endblock %}
{% block content %}
<section class="proposal-header">
    <div class="container">
        <h1>{{ proposal.book_title }}</h1>
        <div class="proposal-meta">
            <span>{{ proposal.author_name }}</span>
            <span>{{ proposal.author_email }}</span>
            <span>{{ proposal.submitted_at.strftime('%B %d, %Y') if proposal.submitted_at else 'N/A' }}</span>
            {% if proposal.tier %}<span class="tier-badge tier-{{ proposal.tier|lower }}">{{ proposal.tier }}-Tier</span>{% else %}<span class="status-badge submitted">{{ proposal.status|replace('_', ' ')|title }}</span>{% endif %}
        </div>
    </div>
</section>

<div class="container">
    <div class="detail-grid">
        <div>
            {% if proposal.status == 'processing' %}
            <div class="detail-section" style="text-align: center; padding: 3rem;">
                <h3>Evaluation In Progress</h3>
                <p style="color: var(--gray-600); margin-top: 1rem;">The AI is currently evaluating this proposal. This page will update automatically when complete.</p>
                <script>setTimeout(function(){ window.location.reload(); }, 5000);</script>
            </div>
            {% elif proposal.status == 'error' %}
            <div class="detail-section" style="text-align: center; padding: 3rem;">
                <h3 style="color: var(--error);">Evaluation Failed</h3>
                <p style="color: var(--gray-600); margin-top: 1rem;">The AI evaluation encountered an error. The author can resubmit their proposal.</p>
            </div>
            {% else %}

            {# Set up variables for both old and new data formats #}
            {% set total_score = evaluation.get('total_score', evaluation.get('overall_score', proposal.overall_score or 0)) %}
            {% set exec_summary = evaluation.get('executiveSummary', '') or evaluation.get('summary', 'No summary available.') %}
            {% set tier_desc = evaluation.get('tierDescription', '') %}
            {% set scores = evaluation.get('scores', {}) %}
            {% set detailed = evaluation.get('detailedAnalysis', {}) %}
            {% set old_categories = evaluation.get('categories', {}) %}
            {% set red_flags = evaluation.get('redFlags', []) or evaluation.get('red_flags', []) %}
            {% set strengths = evaluation.get('strengths', []) %}
            {% set improvements = evaluation.get('improvements', []) %}
            {% set priority_plan = evaluation.get('priorityActionPlan', []) %}
            {% set adv_est = evaluation.get('advanceEstimate', {}) %}
            {% set adv_old = evaluation.get('advance_estimate', {}) %}
            {% set next_steps = evaluation.get('recommendedNextSteps', []) or evaluation.get('next_steps', []) %}

            <div class="detail-section">
                <h3>Evaluation Summary</h3>
                <p><strong>Overall Score:</strong> {% if proposal.overall_score is not none %}{{ proposal.overall_score|round|int }}/100{% else %}N/A{% endif %}</p>
                {% if tier_desc %}<p style="color: var(--gray-500); font-size: 0.875rem;">{{ tier_desc }}</p>{% endif %}
                <p style="margin-top: 1rem;">{{ exec_summary }}</p>

                {% if adv_est and adv_est.get('reasoning') %}
                <div style="margin-top: 1rem; padding: 1rem; background: var(--gold-light); border-radius: var(--radius);">
                    <strong>Advance Estimate:</strong>
                    {% if adv_est.get('viable', true) %}
                    ${{ "{:,.0f}".format(adv_est.get('lowRange', 0)|float) }} - ${{ "{:,.0f}".format(adv_est.get('highRange', 0)|float) }}
                    ({{ adv_est.get('confidence', 'N/A') }} confidence)
                    {% else %}
                    Not yet viable for traditional advance
                    {% endif %}
                    <p style="font-size: 0.875rem; margin-top: 0.5rem;">{{ adv_est.get('reasoning', '') }}</p>
                </div>
                {% elif adv_old and (adv_old.get('low') or adv_old.get('high')) %}
                <div style="margin-top: 1rem; padding: 1rem; background: var(--gold-light); border-radius: var(--radius);">
                    <strong>Advance Estimate:</strong> ${{ "{:,.0f}".format(adv_old.get('low', 0)|float) }} - ${{ "{:,.0f}".format(adv_old.get('high', 0)|float) }}
                    <p style="font-size: 0.875rem; margin-top: 0.5rem;">{{ adv_old.get('notes', '') }}</p>
                </div>
                {% endif %}
            </div>

            {% if red_flags and red_flags|length > 0 %}
            <div class="detail-section" style="border-left: 4px solid var(--error);">
                <h3 style="color: var(--error);">Red Flags</h3>
                <ul>{% for flag in red_flags %}<li>{{ flag|replace('_', ' ')|title }}</li>{% endfor %}</ul>
            </div>
            {% endif %}

            <div class="detail-section">
                <h3>Score Breakdown</h3>
                {% if scores %}
                {% set category_labels = [
                    ('marketing', 'Marketing & Platform'),
                    ('overview', 'Overview & Concept'),
                    ('credentials', 'Author Credentials'),
                    ('comps', 'Comparative Titles'),
                    ('writing', 'Sample Writing'),
                    ('outline', 'Book Outline'),
                    ('completeness', 'Completeness')
                ] %}
                {% for key, label in category_labels %}
                {% set score_data = scores.get(key, {}) %}
                {% set score = score_data.get('score', 0) if score_data is mapping else (score_data or 0) %}
                <div style="padding: 0.75rem 0; border-bottom: 1px solid var(--gray-200);">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                        <strong>{{ label }}</strong>
                        <span class="{% if score|float >= 70 %}score-high{% elif score|float >= 50 %}score-mid{% else %}score-low{% endif %}">{{ score|int }}/100</span>
                    </div>
                    <div style="height: 6px; background: var(--gray-200); border-radius: 3px; overflow: hidden;">
                        <div style="height: 100%; width: {{ score|int }}%; background: var(--primary); border-radius: 3px;"></div>
                    </div>
                </div>
                {% endfor %}
                {% elif old_categories %}
                {% for key, cat in old_categories.items() %}
                {% set score = cat.get('score', 0)|float %}
                <div style="padding: 0.75rem 0; border-bottom: 1px solid var(--gray-200);">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <strong>{{ key|replace('_', ' ')|title }}</strong>
                        <span class="{% if score >= 70 %}score-high{% elif score >= 50 %}score-mid{% else %}score-low{% endif %}">{{ score|round|int }}/100</span>
                    </div>
                    <p style="font-size: 0.875rem; color: var(--gray-600);">{{ cat.get('feedback', 'No feedback available.') }}</p>
                </div>
                {% endfor %}
                {% endif %}
            </div>

            {% if strengths %}
            <div class="detail-section">
                <h3>Top Strengths</h3>
                <ul>{% for item in strengths %}<li>{{ item }}</li>{% endfor %}</ul>
            </div>
            {% endif %}

            {% if improvements %}
            <div class="detail-section">
                <h3>Key Improvements Needed</h3>
                <ul>{% for item in improvements %}<li>{{ item }}</li>{% endfor %}</ul>
            </div>
            {% endif %}

            {% if priority_plan and priority_plan|length > 0 %}
            <div class="detail-section">
                <h3>Priority Action Plan</h3>
                {% for action in priority_plan %}
                <div style="padding: 0.75rem; margin-bottom: 0.5rem; background: var(--gray-100); border-left: 3px solid var(--primary); border-radius: 0 var(--radius) var(--radius) 0;">
                    <strong style="color: var(--primary);">#{{ action.get('priority', loop.index) }}: {{ action.get('action', '') }}</strong>
                    <div style="font-size: 0.8125rem; color: var(--gray-500); margin-top: 0.25rem;">
                        {{ action.get('timeline', '') }}{% if action.get('impact') %} &mdash; {{ action.impact }}{% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            {% if next_steps %}
            <div class="detail-section">
                <h3>Recommended Next Steps</h3>
                <ol>{% for item in next_steps %}<li>{{ item }}</li>{% endfor %}</ol>
            </div>
            {% endif %}
            {% endif %}
        </div>

        <div>
            <div class="detail-section">
                <h3>Status & Actions</h3>
                <form method="POST">
                    <div class="form-group">
                        <label for="status">Status</label>
                        <select name="status" id="status">
                            {% for value, label in status_options %}
                            <option value="{{ value }}" {% if proposal.status == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="notes">Internal Notes</label>
                        <textarea name="notes" id="notes" rows="5" placeholder="Add team notes...">{{ proposal.notes or '' }}</textarea>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Save Changes</button>
                </form>
            </div>

            <div class="detail-section">
                <h3>Email Status</h3>
                <p>Author Email: {% if proposal.author_email_sent %}Sent{% else %}Not sent{% endif %}</p>
                <p>Team Email: {% if proposal.team_email_sent %}Sent{% else %}Not sent{% endif %}</p>
                <form method="POST" action="{{ url_for('resend_author_email', submission_id=proposal.submission_id) }}" style="margin-top: 1rem;">
                    <button type="submit" class="btn btn-outline" style="width: 100%;">Resend to Author</button>
                </form>
            </div>

            <div class="detail-section">
                <h3>Documents</h3>
                {% if proposal.evaluation_json %}
                <a href="{{ url_for('download_pdf', submission_id=proposal.submission_id) }}" class="btn btn-gold" style="width: 100%; text-align: center;">Download PDF Report</a>
                {% else %}
                <p style="color: var(--gray-500); text-align: center;">PDF available after evaluation completes</p>
                {% endif %}
                <a href="{{ url_for('results', submission_id=proposal.submission_id) }}" class="btn btn-outline" style="width: 100%; margin-top: 0.5rem; text-align: center;">View Public Page</a>
            </div>

            <div class="detail-section">
                <h3>Original Proposal</h3>
                {% if proposal.original_file %}
                <a href="{{ url_for('download_proposal_text', submission_id=proposal.submission_id) }}" class="btn btn-accent" style="width: 100%; text-align: center;">Download Original {{ proposal.original_filename.rsplit('.', 1)[-1]|upper if proposal.original_filename else 'File' }}</a>
                {% endif %}
                {% if proposal.proposal_text %}
                <a href="{{ url_for('view_proposal_text', submission_id=proposal.submission_id) }}" class="btn {% if proposal.original_file %}btn-outline{% else %}btn-primary{% endif %}" style="width: 100%; margin-top: 0.5rem; text-align: center;">View Extracted Text</a>
                <p style="font-size: 0.75rem; color: var(--gray-500); margin-top: 0.5rem; text-align: center;">{{ "{:,}".format(proposal.proposal_text|length) }} characters of extracted text</p>
                {% elif not proposal.original_file %}
                <p style="color: var(--gray-500); text-align: center;">No proposal available</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
