{% extends "base.html" %}
{% block title %}{{ proposal.book_title }} - Admin{% endblock %}
{% block content %}
<section class="proposal-header">
    <div class="container">
        <h1>{{ proposal.book_title }}</h1>
        <div class="proposal-meta">
            <span>üë§ {{ proposal.author_name }}</span>
            <span>üìß {{ proposal.author_email }}</span>
            <span>üìÖ {{ proposal.submitted_at.strftime('%B %d, %Y') }}</span>
            <span class="tier-badge tier-{{ proposal.tier|lower }}">{{ proposal.tier }}-Tier</span>
        </div>
    </div>
</section>

<div class="container">
    <div class="detail-grid">
        <div>
            <div class="detail-section">
                <h3>üìä Evaluation Summary</h3>
                <p><strong>Overall Score:</strong> {{ proposal.overall_score|round|int }}/100</p>
                <p style="margin-top: 1rem;">{{ evaluation.get('summary', 'No summary available.') }}</p>
                {% if evaluation.get('advance_estimate') %}
                <div style="margin-top: 1rem; padding: 1rem; background: var(--gold-light); border-radius: var(--radius);">
                    <strong>Advance Estimate:</strong> ${{ "{:,.0f}".format(evaluation.advance_estimate.low) }} - ${{ "{:,.0f}".format(evaluation.advance_estimate.high) }}
                    <p style="font-size: 0.875rem; margin-top: 0.5rem;">{{ evaluation.advance_estimate.notes }}</p>
                </div>
                {% endif %}
            </div>

            <div class="detail-section">
                <h3>üìà Category Scores</h3>
                {% for key, cat in evaluation.get('categories', {}).items() %}
                <div style="padding: 1rem 0; border-bottom: 1px solid var(--gray-200);">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <strong>{{ key|replace('_', ' ')|title }}</strong>
                        <span class="{% if cat.score >= 70 %}score-high{% elif cat.score >= 50 %}score-mid{% else %}score-low{% endif %}">{{ cat.score }}/100</span>
                    </div>
                    <p style="font-size: 0.875rem; color: var(--gray-600);">{{ cat.feedback }}</p>
                </div>
                {% endfor %}
            </div>

            {% if evaluation.get('strengths') %}
            <div class="detail-section">
                <h3>‚úÖ Strengths</h3>
                <ul>{% for item in evaluation.strengths %}<li>{{ item }}</li>{% endfor %}</ul>
            </div>
            {% endif %}

            {% if evaluation.get('red_flags') %}
            <div class="detail-section">
                <h3>‚ö†Ô∏è Red Flags</h3>
                <ul>{% for item in evaluation.red_flags %}<li>{{ item }}</li>{% endfor %}</ul>
            </div>
            {% endif %}

            {% if evaluation.get('next_steps') %}
            <div class="detail-section">
                <h3>üéØ Next Steps</h3>
                <ol>{% for item in evaluation.next_steps %}<li>{{ item }}</li>{% endfor %}</ol>
            </div>
            {% endif %}
        </div>

        <div>
            <div class="detail-section">
                <h3>‚öôÔ∏è Status & Actions</h3>
                <form method="POST">
                    <div class="form-group">
                        <label for="status">Status</label>
                        <select name="status" id="status">
                            {% for value, label in status_options %}
                            <option value="{{ value }}" {% if proposal.status == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="notes">Internal Notes</label>
                        <textarea name="notes" id="notes" rows="5" placeholder="Add team notes...">{{ proposal.notes or '' }}</textarea>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Save Changes</button>
                </form>
            </div>

            <div class="detail-section">
                <h3>üìß Email Status</h3>
                <p>Author Email: {% if proposal.author_email_sent %}‚úÖ Sent{% else %}‚ùå Not sent{% endif %}</p>
                <p>Team Email: {% if proposal.team_email_sent %}‚úÖ Sent{% else %}‚ùå Not sent{% endif %}</p>
                <form method="POST" action="{{ url_for('resend_author_email', submission_id=proposal.submission_id) }}" style="margin-top: 1rem;">
                    <button type="submit" class="btn btn-outline" style="width: 100%;">Resend to Author</button>
                </form>
            </div>

            <div class="detail-section">
                <h3>üìÑ Documents</h3>
                <a href="{{ url_for('download_pdf', submission_id=proposal.submission_id) }}" class="btn btn-gold" style="width: 100%; text-align: center;">Download PDF Report</a>
                <a href="{{ url_for('results', submission_id=proposal.submission_id) }}" class="btn btn-outline" style="width: 100%; margin-top: 0.5rem; text-align: center;">View Public Page</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}
