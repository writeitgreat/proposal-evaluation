{% extends "base.html" %}
{% block title %}{{ proposal.book_title }} - Admin{% endblock %}
{% block content %}
<section class="proposal-header">
    <div class="container">
        <h1>{{ proposal.book_title }}</h1>
        <div class="proposal-meta">
            <span>{{ proposal.author_name }}</span>
            <span>{{ proposal.author_email }}</span>
            <span>{{ proposal.submitted_at.strftime('%B %d, %Y') if proposal.submitted_at else 'N/A' }}</span>
            {% if proposal.tier %}<span class="tier-badge tier-{{ proposal.tier|lower }}">{{ proposal.tier }}-Tier</span>{% else %}<span class="status-badge submitted">{{ proposal.status|replace('_', ' ')|title }}</span>{% endif %}
        </div>
    </div>
</section>

<div class="container">
    <div class="detail-grid">
        <div>
            {% if proposal.status == 'processing' %}
            <div class="detail-section" style="text-align: center; padding: 3rem;">
                <h3>Evaluation In Progress</h3>
                <p style="color: var(--gray-600); margin-top: 1rem;">The AI is currently evaluating this proposal. This page will update automatically when complete.</p>
                <script>setTimeout(function(){ window.location.reload(); }, 5000);</script>
            </div>
            {% elif proposal.status == 'error' %}
            <div class="detail-section" style="text-align: center; padding: 3rem;">
                <h3 style="color: var(--error);">Evaluation Failed</h3>
                <p style="color: var(--gray-600); margin-top: 1rem;">The AI evaluation encountered an error. The author can resubmit their proposal.</p>
            </div>
            {% else %}
            <div class="detail-section">
                <h3>Evaluation Summary</h3>
                <p><strong>Overall Score:</strong> {% if proposal.overall_score is not none %}{{ proposal.overall_score|round|int }}/100{% else %}N/A{% endif %}</p>
                <p style="margin-top: 1rem;">{{ evaluation.get('summary', 'No summary available.') }}</p>
                {% if evaluation.get('advance_estimate') %}
                {% set advance = evaluation.get('advance_estimate', {}) %}
                <div style="margin-top: 1rem; padding: 1rem; background: var(--gold-light); border-radius: var(--radius);">
                    <strong>Advance Estimate:</strong> ${{ "{:,.0f}".format(advance.get('low', 0)|float) }} - ${{ "{:,.0f}".format(advance.get('high', 0)|float) }}
                    <p style="font-size: 0.875rem; margin-top: 0.5rem;">{{ advance.get('notes', '') }}</p>
                </div>
                {% endif %}
            </div>

            <div class="detail-section">
                <h3>Category Scores</h3>
                {% for key, cat in evaluation.get('categories', {}).items() %}
                {% set score = cat.get('score', 0)|float %}
                <div style="padding: 1rem 0; border-bottom: 1px solid var(--gray-200);">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <strong>{{ key|replace('_', ' ')|title }}</strong>
                        <span class="{% if score >= 70 %}score-high{% elif score >= 50 %}score-mid{% else %}score-low{% endif %}">{{ score|round|int }}/100</span>
                    </div>
                    <p style="font-size: 0.875rem; color: var(--gray-600);">{{ cat.get('feedback', 'No feedback available.') }}</p>
                    {% if cat.get('priority_actions') %}
                    <div style="margin-top: 0.5rem;">
                        <strong style="font-size: 0.75rem; color: var(--gray-500);">PRIORITY ACTIONS:</strong>
                        <ul style="margin: 0.25rem 0 0; padding-left: 1.25rem; font-size: 0.8125rem;">
                            {% for action in cat.get('priority_actions', []) %}
                            <li>{{ action }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>

            {% if evaluation.get('strengths') %}
            <div class="detail-section">
                <h3>Strengths</h3>
                <ul>{% for item in evaluation.get('strengths', []) %}<li>{{ item }}</li>{% endfor %}</ul>
            </div>
            {% endif %}

            {% if evaluation.get('red_flags') %}
            <div class="detail-section">
                <h3>Red Flags</h3>
                <ul>{% for item in evaluation.get('red_flags', []) %}<li>{{ item }}</li>{% endfor %}</ul>
            </div>
            {% endif %}

            {% if evaluation.get('next_steps') %}
            <div class="detail-section">
                <h3>Next Steps</h3>
                <ol>{% for item in evaluation.get('next_steps', []) %}<li>{{ item }}</li>{% endfor %}</ol>
            </div>
            {% endif %}
            {% endif %}
        </div>

        <div>
            <div class="detail-section">
                <h3>Status & Actions</h3>
                <form method="POST">
                    <div class="form-group">
                        <label for="status">Status</label>
                        <select name="status" id="status">
                            {% for value, label in status_options %}
                            <option value="{{ value }}" {% if proposal.status == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="notes">Internal Notes</label>
                        <textarea name="notes" id="notes" rows="5" placeholder="Add team notes...">{{ proposal.notes or '' }}</textarea>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Save Changes</button>
                </form>
            </div>

            <div class="detail-section">
                <h3>Email Status</h3>
                <p>Author Email: {% if proposal.author_email_sent %}Sent{% else %}Not sent{% endif %}</p>
                <p>Team Email: {% if proposal.team_email_sent %}Sent{% else %}Not sent{% endif %}</p>
                <form method="POST" action="{{ url_for('resend_author_email', submission_id=proposal.submission_id) }}" style="margin-top: 1rem;">
                    <button type="submit" class="btn btn-outline" style="width: 100%;">Resend to Author</button>
                </form>
            </div>

            <div class="detail-section">
                <h3>Documents</h3>
                {% if proposal.evaluation_json %}
                <a href="{{ url_for('download_pdf', submission_id=proposal.submission_id) }}" class="btn btn-gold" style="width: 100%; text-align: center;">Download PDF Report</a>
                {% else %}
                <p style="color: var(--gray-500); text-align: center;">PDF available after evaluation completes</p>
                {% endif %}
                <a href="{{ url_for('results', submission_id=proposal.submission_id) }}" class="btn btn-outline" style="width: 100%; margin-top: 0.5rem; text-align: center;">View Public Page</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}
