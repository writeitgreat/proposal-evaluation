{% extends "base.html" %}
{% block title %}Proposal Coach — Write It Great{% endblock %}

{% block extra_css %}
/* ── Layout ─────────────────────────────────────────── */
html, body { height: 100%; }
main { display: flex; flex-direction: column; height: calc(100vh - 80px); }

.coach-shell {
    display: flex;
    flex-direction: column;
    flex: 1;
    max-width: 800px;
    width: 100%;
    margin: 0 auto;
    padding: 0 1rem;
    min-height: 0;
}

/* ── Header bar ─────────────────────────────────────── */
.coach-topbar {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--gray-200);
    flex-shrink: 0;
}
.coach-avatar {
    width: 36px; height: 36px; border-radius: 50%;
    background: var(--primary);
    display: flex; align-items: center; justify-content: center;
    color: var(--accent); font-size: 1rem; font-weight: 700; flex-shrink: 0;
}
.coach-identity { flex: 1; min-width: 0; }
.coach-identity strong { font-size: 0.9375rem; color: var(--gray-900); display: block; }
.coach-identity span   { font-size: 0.75rem;   color: var(--gray-500); }

.coach-title-wrap { display: flex; align-items: center; gap: 0.5rem; }
.coach-title-wrap label { font-size: 0.8125rem; font-weight: 600; color: var(--gray-600); white-space: nowrap; }
#coach-title-input {
    padding: 0.35rem 0.625rem;
    border: 1.5px solid var(--gray-200); border-radius: var(--radius);
    font-size: 0.875rem; font-family: inherit; width: 200px;
    transition: border-color 0.2s;
}
#coach-title-input:focus { outline: none; border-color: var(--primary); }
#btn-clear-session {
    background: none; border: none; cursor: pointer;
    font-size: 0.75rem; color: var(--gray-400); padding: 0.25rem 0.5rem;
    border-radius: var(--radius); transition: all 0.15s;
}
#btn-clear-session:hover { color: var(--error); background: #fee2e2; }

/* ── Messages ───────────────────────────────────────── */
.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1.25rem 0;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    min-height: 0;
}

.msg { display: flex; gap: 0.625rem; max-width: 88%; }
.msg.agent { align-self: flex-start; }
.msg.user  { align-self: flex-end; flex-direction: row-reverse; }

.msg-avatar {
    width: 32px; height: 32px; border-radius: 50%; flex-shrink: 0;
    display: flex; align-items: center; justify-content: center;
    font-size: 0.875rem; font-weight: 700; margin-top: 2px;
}
.msg.agent .msg-avatar { background: var(--primary); color: var(--accent); }
.msg.user  .msg-avatar { background: var(--accent);  color: var(--accent-text); }

.msg-bubble {
    padding: 0.75rem 1rem;
    border-radius: 16px;
    font-size: 0.9375rem;
    line-height: 1.65;
    white-space: pre-wrap;
    word-break: break-word;
}
.msg.agent .msg-bubble {
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: 4px 16px 16px 16px;
    color: var(--gray-900);
    box-shadow: var(--shadow);
}
.msg.user .msg-bubble {
    background: var(--primary);
    color: white;
    border-radius: 16px 4px 16px 16px;
}

/* Typing indicator */
.typing-bubble {
    background: white; border: 1px solid var(--gray-200);
    border-radius: 4px 16px 16px 16px;
    padding: 0.75rem 1rem; box-shadow: var(--shadow);
    display: flex; align-items: center; gap: 5px;
}
.typing-bubble span {
    width: 7px; height: 7px; border-radius: 50%;
    background: var(--gray-400);
    animation: typingBounce 1.2s infinite ease-in-out;
    display: inline-block;
}
.typing-bubble span:nth-child(2) { animation-delay: 0.2s; }
.typing-bubble span:nth-child(3) { animation-delay: 0.4s; }
@keyframes typingBounce {
    0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
    30% { transform: translateY(-5px); opacity: 1; }
}

/* Submit-proposal prompt (appears at end of coaching) */
.coach-cta {
    background: linear-gradient(135deg, #f0fdf4, #dcfce7);
    border: 1px solid #86efac; border-radius: var(--radius);
    padding: 1rem 1.25rem; margin-top: 0.5rem;
    display: flex; align-items: center; justify-content: space-between;
    gap: 1rem; flex-wrap: wrap;
}
.coach-cta p { color: #166534; font-size: 0.9rem; margin: 0; flex: 1; }
.coach-cta a {
    background: var(--primary); color: white;
    padding: 0.55rem 1.125rem; border-radius: var(--radius);
    font-weight: 700; text-decoration: none; font-size: 0.875rem;
    white-space: nowrap; transition: background 0.2s;
}
.coach-cta a:hover { background: var(--primary-light); }

/* ── Input area ─────────────────────────────────────── */
.chat-input-area {
    border-top: 1px solid var(--gray-200);
    padding: 0.875rem 0 1rem;
    flex-shrink: 0;
    display: flex;
    gap: 0.625rem;
    align-items: flex-end;
}
#chat-input {
    flex: 1;
    padding: 0.75rem 1rem;
    border: 2px solid var(--gray-200); border-radius: 12px;
    font-size: 0.9375rem; font-family: inherit; line-height: 1.5;
    resize: none; max-height: 140px; overflow-y: auto;
    transition: border-color 0.2s;
}
#chat-input:focus { outline: none; border-color: var(--primary); }
#chat-input::placeholder { color: var(--gray-400); }
#btn-send {
    width: 44px; height: 44px; border-radius: 50%;
    background: var(--primary); border: none; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s; flex-shrink: 0;
}
#btn-send:hover   { background: var(--primary-light); }
#btn-send:disabled { background: var(--gray-300); cursor: not-allowed; }
#btn-send svg { width: 18px; height: 18px; }
{% endblock %}

{% block content %}
<div class="coach-shell">

    <!-- Top bar -->
    <div class="coach-topbar">
        <div class="coach-avatar">W</div>
        <div class="coach-identity">
            <strong>Book Proposal Coach</strong>
            <span>Write It Great</span>
        </div>
        <div class="coach-title-wrap">
            <label for="coach-title-input">Working title:</label>
            <input type="text" id="coach-title-input" placeholder="Optional" autocomplete="off">
        </div>
        <button id="btn-clear-session" title="Start a new session">↺ New session</button>
    </div>

    <!-- Messages -->
    <div class="chat-messages" id="chat-messages"></div>

    <!-- Input -->
    <div class="chat-input-area">
        <textarea id="chat-input" rows="1" placeholder="Share your idea or answer the coach's question…"></textarea>
        <button id="btn-send" aria-label="Send">
            <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
            </svg>
        </button>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
(function () {
    const STORAGE_KEY  = 'wig_coach_chat_v1';
    const WELCOME_MSG  = "Hi{{ ', ' + current_user.name if current_user.is_authenticated else '' }}! I'm your book proposal coach at Write It Great.\n\nI've helped dozens of authors develop proposals that landed publishing deals — and I'm here to do the same with you. We'll work through your idea together, one step at a time.\n\n**What's your book about?** Don't worry about having the perfect pitch — just tell me in your own words, like you'd explain it to a friend.";

    /* ── State ──────────────────────────────────────── */
    let messages   = [];   // { role, content }
    let isWaiting  = false;
    let readyForSubmit = false;

    /* ── DOM ────────────────────────────────────────── */
    const chatEl    = document.getElementById('chat-messages');
    const inputEl   = document.getElementById('chat-input');
    const sendBtn   = document.getElementById('btn-send');
    const clearBtn  = document.getElementById('btn-clear-session');
    const titleInput= document.getElementById('coach-title-input');

    /* ── Persist ────────────────────────────────────── */
    function save() {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify({
                messages, title: titleInput.value, readyForSubmit
            }));
        } catch (_) {}
    }
    function restore() {
        try {
            const d = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
            if (d.title)    titleInput.value = d.title;
            if (d.readyForSubmit) readyForSubmit = true;
            if (Array.isArray(d.messages) && d.messages.length) {
                messages = d.messages;
                messages.forEach(m => appendBubble(m.role, m.content, false));
                if (readyForSubmit) showSubmitCTA();
                return true;
            }
        } catch (_) {}
        return false;
    }

    /* ── Render ─────────────────────────────────────── */
    function appendBubble(role, content, scroll = true) {
        const wrap = document.createElement('div');
        wrap.className = `msg ${role}`;

        const avatar = document.createElement('div');
        avatar.className = 'msg-avatar';
        avatar.textContent = role === 'agent' ? 'W' : '{{ current_user.name[0]|upper if current_user.is_authenticated else "A" }}';

        const bubble = document.createElement('div');
        bubble.className = 'msg-bubble';
        bubble.innerHTML = formatMessage(content);

        wrap.appendChild(avatar);
        wrap.appendChild(bubble);
        chatEl.appendChild(wrap);
        if (scroll) chatEl.scrollTop = chatEl.scrollHeight;
        return wrap;
    }

    function formatMessage(text) {
        // Bold **text**, line breaks
        return text
            .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
            .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
            .replace(/\n/g, '<br>');
    }

    function showTyping() {
        const wrap = document.createElement('div');
        wrap.className = 'msg agent';
        wrap.id = 'typing-indicator';

        const avatar = document.createElement('div');
        avatar.className = 'msg-avatar';
        avatar.textContent = 'W';

        const bubble = document.createElement('div');
        bubble.className = 'typing-bubble';
        bubble.innerHTML = '<span></span><span></span><span></span>';

        wrap.appendChild(avatar);
        wrap.appendChild(bubble);
        chatEl.appendChild(wrap);
        chatEl.scrollTop = chatEl.scrollHeight;
    }

    function removeTyping() {
        const t = document.getElementById('typing-indicator');
        if (t) t.remove();
    }

    function showSubmitCTA() {
        if (document.getElementById('coach-cta')) return;
        const cta = document.createElement('div');
        cta.className = 'coach-cta';
        cta.id = 'coach-cta';
        cta.innerHTML = `
            <p>Your proposal sections are looking strong. Ready for a full evaluation with scoring and advance estimate?</p>
            <a href="{{ url_for('index') }}">Go to Full Evaluation →</a>`;
        chatEl.appendChild(cta);
        chatEl.scrollTop = chatEl.scrollHeight;
    }

    /* ── Send a message ─────────────────────────────── */
    async function send(text) {
        text = text.trim();
        if (!text || isWaiting) return;

        isWaiting = true;
        sendBtn.disabled = true;
        inputEl.value = '';
        autoResize();

        // Add user message
        messages.push({ role: 'user', content: text });
        appendBubble('user', text);
        save();

        showTyping();

        try {
            const resp = await fetch('/api/coach-chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    messages: messages.map(m => ({ role: m.role === 'agent' ? 'assistant' : m.role, content: m.content })),
                    book_title: titleInput.value.trim()
                })
            });
            const data = await resp.json();
            removeTyping();

            if (data.success && data.message) {
                messages.push({ role: 'agent', content: data.message });
                appendBubble('agent', data.message);

                // Detect if the agent is signalling readiness to submit
                const lower = data.message.toLowerCase();
                if (!readyForSubmit && (lower.includes('ready to submit') || lower.includes('submit for') || lower.includes('full evaluation'))) {
                    readyForSubmit = true;
                    showSubmitCTA();
                }
                save();
            } else {
                appendBubble('agent', 'Sorry, I had trouble responding. Please try again.');
            }
        } catch (e) {
            removeTyping();
            appendBubble('agent', 'Network error — please check your connection and try again.');
        }

        isWaiting = false;
        sendBtn.disabled = false;
        inputEl.focus();
    }

    /* ── Auto-resize textarea ───────────────────────── */
    function autoResize() {
        inputEl.style.height = 'auto';
        inputEl.style.height = Math.min(inputEl.scrollHeight, 140) + 'px';
    }
    inputEl.addEventListener('input', autoResize);

    /* ── Event listeners ────────────────────────────── */
    sendBtn.addEventListener('click', () => send(inputEl.value));
    inputEl.addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(inputEl.value); }
    });

    titleInput.addEventListener('change', save);

    clearBtn.addEventListener('click', () => {
        if (!confirm('Start a new coaching session? Your current conversation will be cleared.')) return;
        localStorage.removeItem(STORAGE_KEY);
        messages = [];
        readyForSubmit = false;
        chatEl.innerHTML = '';
        titleInput.value = '';
        boot();
    });

    /* ── Boot ───────────────────────────────────────── */
    function boot() {
        const hadSession = restore();
        if (!hadSession) {
            // Show welcome message and seed it into the history
            messages.push({ role: 'agent', content: WELCOME_MSG });
            appendBubble('agent', WELCOME_MSG);
            save();
        }
        inputEl.focus();
        chatEl.scrollTop = chatEl.scrollHeight;
    }

    boot();
})();
</script>
{% endblock %}
