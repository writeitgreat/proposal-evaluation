{% extends "base.html" %}
{% block title %}Evaluation Results - {{ proposal.book_title }}{% endblock %}
{% block content %}
<section class="results-header">
    <h1>{{ proposal.book_title }}</h1>
    <p>by {{ proposal.author_name }}</p>
</section>

<div class="container results-container">
    <div class="card tier-{{ (proposal.tier or 'c')|lower }}">
        {% if proposal.author_email_sent %}
        <div class="email-notice">
            <svg width="24" height="24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
            <span>A copy has been sent to <strong>{{ proposal.author_email }}</strong></span>
        </div>
        {% endif %}

        <div class="score-card">
            <div class="score-main">
                <div class="tier-display">{{ proposal.tier or 'N/A' }}-Tier</div>
                <div class="score-number">{{ proposal.overall_score|default(0, true)|round|int }}/100</div>
            </div>
            <div class="summary-box">
                <p>{{ evaluation.get('summary', 'Your proposal has been evaluated.') }}</p>
            </div>
        </div>

        {% if evaluation.get('advance_estimate') %}
        {% set advance = evaluation.get('advance_estimate', {}) %}
        <div class="advance-estimate">
            <div style="font-size: 0.875rem; color: var(--gray-600);">Estimated Advance Range</div>
            <div class="advance-range">${{ "{:,.0f}".format(advance.get('low', 0)|float) }} - ${{ "{:,.0f}".format(advance.get('high', 0)|float) }}</div>
            <div class="advance-note">{{ advance.get('notes', '') }}</div>
        </div>
        {% endif %}

        <h3 class="section-title">Category Scores</h3>
        <div class="category-grid">
            {% for key, cat in evaluation.get('categories', {}).items() %}
            {% set score = cat.get('score', 0)|float %}
            <div class="category-card">
                <div class="category-header">
                    <span class="category-name">{{ key|replace('_', ' ')|title }}</span>
                    <span class="category-score {% if score >= 70 %}score-high{% elif score >= 50 %}score-mid{% else %}score-low{% endif %}">{{ score|round|int }}/100</span>
                </div>
                <p class="category-feedback">{{ cat.get('feedback', 'No feedback available.') }}</p>
                {% if cat.get('priority_actions') %}
                <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--gray-200);">
                    <strong style="font-size: 0.75rem; color: var(--gray-500);">PRIORITY ACTIONS:</strong>
                    <ul style="margin: 0.5rem 0 0; padding-left: 1rem; font-size: 0.8125rem;">
                        {% for action in cat.get('priority_actions', []) %}
                        <li>{{ action }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        {% if evaluation.get('strengths') %}
        <h3 class="section-title">Strengths</h3>
        <div class="list-section strengths-box">
            <ul>
            {% for item in evaluation.get('strengths', []) %}
                <li>{{ item }}</li>
            {% endfor %}
            </ul>
        </div>
        {% endif %}

        {% if evaluation.get('red_flags') %}
        <h3 class="section-title">Areas of Concern</h3>
        <div class="list-section flags-box">
            <ul>
            {% for item in evaluation.get('red_flags', []) %}
                <li>{{ item }}</li>
            {% endfor %}
            </ul>
        </div>
        {% endif %}

        {% if evaluation.get('next_steps') %}
        <h3 class="section-title">Recommended Next Steps</h3>
        <div class="list-section steps-box">
            <ol>
            {% for item in evaluation.get('next_steps', []) %}
                <li>{{ item }}</li>
            {% endfor %}
            </ol>
        </div>
        {% endif %}

        <div class="download-section">
            <h3>Download Your Full Report</h3>
            <p style="color: var(--gray-600); margin-bottom: 1.5rem;">Get a detailed PDF report with complete feedback and priority actions.</p>
            <a href="{{ url_for('download_pdf', submission_id=proposal.submission_id) }}" class="btn btn-primary">Download PDF Report</a>
        </div>
    </div>
</div>
{% endblock %}
