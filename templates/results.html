{% extends "base.html" %}
{% block title %}Evaluation Results - {{ proposal.book_title }}{% endblock %}

{% block extra_css %}
{% if processing %}
.processing-card {
    text-align: center;
    padding: 4rem 2rem;
}
.processing-card .spinner {
    width: 60px;
    height: 60px;
    border: 4px solid var(--gold-light);
    border-top-color: var(--gold);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1.5rem;
}
@keyframes spin { to { transform: rotate(360deg); } }
.processing-card h2 {
    color: var(--primary);
    margin-bottom: 0.75rem;
}
.processing-card p {
    color: var(--gray-600);
    max-width: 400px;
    margin: 0 auto;
}
.processing-steps {
    margin-top: 2rem;
    text-align: left;
    max-width: 350px;
    margin-left: auto;
    margin-right: auto;
}
.processing-steps .step {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 0;
    color: var(--gray-500);
    font-size: 0.9375rem;
}
.processing-steps .step.active {
    color: var(--primary);
    font-weight: 600;
}
.processing-steps .step.done {
    color: var(--success);
}
{% endif %}

{% if proposal.status == 'error' %}
.error-card {
    text-align: center;
    padding: 3rem 2rem;
}
.error-card h2 {
    color: var(--error);
    margin-bottom: 1rem;
}
.error-card p {
    color: var(--gray-600);
    margin-bottom: 1.5rem;
}
{% endif %}
{% endblock %}

{% block content %}
<section class="results-header">
    <h1>{{ proposal.book_title }}</h1>
    <p>by {{ proposal.author_name }}</p>
</section>

<div class="container results-container">
    {% if processing %}
    <div class="card processing-card" id="processing-card">
        <div class="spinner"></div>
        <h2>Evaluating Your Proposal...</h2>
        <p>Our AI is carefully analyzing your book proposal. This typically takes 30-60 seconds.</p>
        <div class="processing-steps">
            <div class="step done">&#10003; Document uploaded successfully</div>
            <div class="step done">&#10003; Text extracted from document</div>
            <div class="step active">&#9679; Running AI evaluation...</div>
            <div class="step">&#9675; Generating detailed report</div>
            <div class="step">&#9675; Sending email notification</div>
        </div>
    </div>

    {% elif proposal.status == 'error' %}
    <div class="card error-card">
        <h2>Evaluation Error</h2>
        <p>We encountered an issue while evaluating your proposal. Please try submitting again.</p>
        <a href="{{ url_for('index') }}" class="btn btn-primary">Try Again</a>
    </div>

    {% else %}
    <div class="card tier-{{ (proposal.tier or 'c')|lower }}">
        {% if proposal.author_email_sent %}
        <div class="email-notice">
            <svg width="24" height="24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
            <span>A copy has been sent to <strong>{{ proposal.author_email }}</strong></span>
        </div>
        {% endif %}

        <div class="score-card">
            <div class="score-main">
                <div class="tier-display">{{ proposal.tier or 'N/A' }}-Tier</div>
                <div class="score-number">{{ proposal.overall_score|default(0, true)|round|int }}/100</div>
            </div>
            <div class="summary-box">
                <p>{{ evaluation.get('summary', 'Your proposal has been evaluated.') }}</p>
            </div>
        </div>

        {% if evaluation.get('advance_estimate') %}
        {% set advance = evaluation.get('advance_estimate', {}) %}
        <div class="advance-estimate">
            <div style="font-size: 0.875rem; color: var(--gray-600);">Estimated Advance Range</div>
            <div class="advance-range">${{ "{:,.0f}".format(advance.get('low', 0)|float) }} - ${{ "{:,.0f}".format(advance.get('high', 0)|float) }}</div>
            <div class="advance-note">{{ advance.get('notes', '') }}</div>
        </div>
        {% endif %}

        <h3 class="section-title">Category Scores</h3>
        <div class="category-grid">
            {% for key, cat in evaluation.get('categories', {}).items() %}
            {% set score = cat.get('score', 0)|float %}
            <div class="category-card">
                <div class="category-header">
                    <span class="category-name">{{ key|replace('_', ' ')|title }}</span>
                    <span class="category-score {% if score >= 70 %}score-high{% elif score >= 50 %}score-mid{% else %}score-low{% endif %}">{{ score|round|int }}/100</span>
                </div>
                <p class="category-feedback">{{ cat.get('feedback', 'No feedback available.') }}</p>
                {% if cat.get('priority_actions') %}
                <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--gray-200);">
                    <strong style="font-size: 0.75rem; color: var(--gray-500);">PRIORITY ACTIONS:</strong>
                    <ul style="margin: 0.5rem 0 0; padding-left: 1rem; font-size: 0.8125rem;">
                        {% for action in cat.get('priority_actions', []) %}
                        <li>{{ action }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        {% if evaluation.get('strengths') %}
        <h3 class="section-title">Strengths</h3>
        <div class="list-section strengths-box">
            <ul>
            {% for item in evaluation.get('strengths', []) %}
                <li>{{ item }}</li>
            {% endfor %}
            </ul>
        </div>
        {% endif %}

        {% if evaluation.get('red_flags') %}
        <h3 class="section-title">Areas of Concern</h3>
        <div class="list-section flags-box">
            <ul>
            {% for item in evaluation.get('red_flags', []) %}
                <li>{{ item }}</li>
            {% endfor %}
            </ul>
        </div>
        {% endif %}

        {% if evaluation.get('next_steps') %}
        <h3 class="section-title">Recommended Next Steps</h3>
        <div class="list-section steps-box">
            <ol>
            {% for item in evaluation.get('next_steps', []) %}
                <li>{{ item }}</li>
            {% endfor %}
            </ol>
        </div>
        {% endif %}

        <div class="download-section">
            <h3>Download Your Full Report</h3>
            <p style="color: var(--gray-600); margin-bottom: 1.5rem;">Get a detailed PDF report with complete feedback and priority actions.</p>
            <a href="{{ url_for('download_pdf', submission_id=proposal.submission_id) }}" class="btn btn-primary">Download PDF Report</a>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
{% if processing %}
<script>
(function() {
    var pollInterval = 3000;
    var statusUrl = "{{ url_for('check_status', submission_id=proposal.submission_id) }}";

    function checkStatus() {
        fetch(statusUrl)
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.ready) {
                    window.location.reload();
                } else {
                    setTimeout(checkStatus, pollInterval);
                }
            })
            .catch(function() {
                setTimeout(checkStatus, pollInterval);
            });
    }

    setTimeout(checkStatus, pollInterval);
})();
</script>
{% endif %}
{% endblock %}
