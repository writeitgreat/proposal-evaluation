{% extends "base.html" %}
{% block title %}{{ proposal.book_title }} - Write It Great{% endblock %}
{% block content %}
<section class="proposal-header">
    <div class="container">
        <h1>{{ proposal.book_title }}</h1>
        <div class="proposal-meta">
            <span>{{ proposal.author_name }}</span>
            <span>{{ proposal.submitted_at.strftime('%B %d, %Y') if proposal.submitted_at else 'N/A' }}</span>
            {% if proposal.tier %}<span class="tier-badge tier-{{ proposal.tier|lower }}">{{ proposal.tier }}-Tier</span>{% endif %}
            <span class="status-badge {{ proposal.status }}">{{ friendly_status }}</span>
        </div>
    </div>
</section>

<div class="container" style="max-width: 900px;">
    <div style="margin-bottom: 1.5rem;">
        <a href="{{ url_for('author_dashboard') }}" class="btn btn-outline" style="padding: 0.5rem 1rem;">&larr; Back to Dashboard</a>
    </div>

    {% if proposal.status == 'processing' %}
    <div class="card" style="text-align: center; padding: 3rem;">
        <h3>Evaluation In Progress</h3>
        <p style="color: var(--gray-600); margin-top: 1rem;">Our AI is currently evaluating your proposal. This page will update automatically when complete.</p>
        <script>setTimeout(function(){ window.location.reload(); }, 5000);</script>
    </div>

    {% elif not evaluation %}
    <div class="card" style="text-align: center; padding: 3rem;">
        <h3>Evaluation Pending</h3>
        <p style="color: var(--gray-600); margin-top: 1rem;">Your proposal is being reviewed. Check back soon for your results.</p>
    </div>

    {% else %}
    {# Set up variables #}
    {% set total_score = evaluation.get('total_score', evaluation.get('overall_score', proposal.overall_score or 0)) %}
    {% set exec_summary = evaluation.get('executiveSummary', '') or evaluation.get('summary', 'No summary available.') %}
    {% set tier_desc = evaluation.get('tierDescription', '') %}
    {% set scores = evaluation.get('scores', {}) %}
    {% set strengths = evaluation.get('strengths', []) %}
    {% set improvements = evaluation.get('improvements', []) %}
    {% set priority_plan = evaluation.get('priorityActionPlan', []) %}
    {% set adv_est = evaluation.get('advanceEstimate', {}) %}
    {% set next_steps = evaluation.get('recommendedNextSteps', []) or evaluation.get('next_steps', []) %}

    <div class="card">
        <h3>Evaluation Summary</h3>
        <p><strong>Overall Score:</strong> {% if proposal.overall_score is not none %}{{ proposal.overall_score|round|int }}/100{% else %}N/A{% endif %}</p>
        {% if tier_desc %}<p style="color: var(--gray-500); font-size: 0.875rem;">{{ tier_desc }}</p>{% endif %}
        <p style="margin-top: 1rem;">{{ exec_summary }}</p>

        {% if adv_est and adv_est.get('viable', false) and adv_est.get('highRange', 0)|float > 0 %}
        <div style="margin-top: 1rem; padding: 1rem; background: var(--gold-light); border-radius: var(--radius);">
            <strong>Estimated Advance Range:</strong>
            ${{ "{:,.0f}".format(adv_est.get('lowRange', 0)|float) }} - ${{ "{:,.0f}".format(adv_est.get('highRange', 0)|float) }}
            {% if adv_est.get('reasoning') %}
            <p style="font-size: 0.875rem; margin-top: 0.5rem;">{{ adv_est.get('reasoning', '') }}</p>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <div class="card" style="margin-top: 1rem;">
        <h3>Score Breakdown</h3>
        {% if scores %}
        {% set category_labels = [
            ('marketing', 'Marketing & Platform'),
            ('overview', 'Overview & Concept'),
            ('credentials', 'Author Credentials'),
            ('comps', 'Comparative Titles'),
            ('writing', 'Sample Writing'),
            ('outline', 'Book Outline'),
            ('completeness', 'Completeness')
        ] %}
        {% for key, label in category_labels %}
        {% set score_data = scores.get(key, {}) %}
        {% set score = score_data.get('score', 0) if score_data is mapping else (score_data or 0) %}
        <div style="padding: 0.75rem 0; border-bottom: 1px solid var(--gray-200);">
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                <strong>{{ label }}</strong>
                <span class="{% if score|float >= 70 %}score-high{% elif score|float >= 50 %}score-mid{% else %}score-low{% endif %}">{{ score|int }}/100</span>
            </div>
            <div style="height: 6px; background: var(--gray-200); border-radius: 3px; overflow: hidden;">
                <div style="height: 100%; width: {{ score|int }}%; background: var(--primary); border-radius: 3px;"></div>
            </div>
        </div>
        {% endfor %}
        {% endif %}
    </div>

    {% if strengths %}
    <div class="card" style="margin-top: 1rem;">
        <h3>Top Strengths</h3>
        <ul>{% for item in strengths %}<li>{{ item }}</li>{% endfor %}</ul>
    </div>
    {% endif %}

    {% if improvements %}
    <div class="card" style="margin-top: 1rem;">
        <h3>Key Improvements Needed</h3>
        <ul>{% for item in improvements %}<li>{{ item }}</li>{% endfor %}</ul>
    </div>
    {% endif %}

    {% if priority_plan and priority_plan|length > 0 %}
    <div class="card" style="margin-top: 1rem;">
        <h3>Priority Action Plan</h3>
        {% for action in priority_plan %}
        <div style="padding: 0.75rem; margin-bottom: 0.5rem; background: var(--gray-100); border-left: 3px solid var(--primary); border-radius: 0 var(--radius) var(--radius) 0;">
            <strong style="color: var(--primary);">#{{ action.get('priority', loop.index) }}: {{ action.get('action', '') }}</strong>
            <div style="font-size: 0.8125rem; color: var(--gray-500); margin-top: 0.25rem;">
                {{ action.get('timeline', '') }}{% if action.get('impact') %} &mdash; {{ action.impact }}{% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {% if next_steps %}
    <div class="card" style="margin-top: 1rem;">
        <h3>Recommended Next Steps</h3>
        <ol>{% for item in next_steps %}<li>{{ item }}</li>{% endfor %}</ol>
    </div>
    {% endif %}

    <div style="text-align: center; margin-top: 1.5rem;">
        {% if proposal.evaluation_json %}
        <a href="{{ url_for('download_pdf', submission_id=proposal.submission_id) }}" class="btn btn-gold">Download PDF Report</a>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}
