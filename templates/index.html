{% extends "base.html" %}
{% block title %}Submit Your Book Proposal - Write It Great{% endblock %}
{% block content %}
<section class="hero">
    <h1>Book Proposal Evaluation</h1>
    <p>Get expert feedback on your book proposal from our team of publishing professionals.</p>
</section>

<div class="container form-container">
    <div class="card">
        <form id="proposal-form" enctype="multipart/form-data">
            {% if current_user.is_authenticated and current_user.is_author %}
            <div style="padding: 1rem; background: var(--gray-100); border-radius: var(--radius); margin-bottom: 1rem;">
                <p style="margin: 0; font-size: 0.875rem; color: var(--gray-600);">Submitting as <strong>{{ current_user.name }}</strong> ({{ current_user.email }})</p>
            </div>
            <input type="hidden" name="author_name" value="{{ current_user.name }}">
            <input type="hidden" name="author_email" value="{{ current_user.email }}">
            {% else %}
            <div class="form-group">
                <label for="author_name">Your Full Name *</label>
                <input type="text" id="author_name" name="author_name" required placeholder="John Smith">
            </div>
            <div class="form-group">
                <label for="author_email">Email Address *</label>
                <input type="email" id="author_email" name="author_email" required placeholder="john@example.com">
                <p class="form-hint">We'll send your evaluation report to this email.</p>
            </div>
            {% endif %}
            <div class="form-group">
                <label for="book_title">Book Title *</label>
                <input type="text" id="book_title" name="book_title" required placeholder="The Art of Writing">
            </div>
            <div class="form-group">
                <label for="proposal_type">Submission Type *</label>
                <select id="proposal_type" name="proposal_type" required>
                    <option value="full">Full Proposal (All Sections)</option>
                    <option value="marketing_only">Marketing Materials Only</option>
                    <option value="no_marketing">Proposal Without Marketing</option>
                </select>
            </div>
            <div class="form-group">
                <label>Upload Your Proposal *</label>
                <div class="upload-zone" id="drop-zone">
                    <input type="file" id="proposal_file" name="proposal_file" accept=".pdf,.doc,.docx" required style="display: none;">
                    <div id="upload-text">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                        </svg>
                        <p>Drag and drop your file here, or <span class="browse-link">browse</span></p>
                        <p class="form-hint">PDF, DOC, or DOCX (max 16MB)</p>
                    </div>
                    <div id="selected-file" class="selected-file hidden">
                        <svg width="24" height="24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        <span id="selected-filename"></span>
                    </div>
                </div>
            </div>
            <!-- Marketing Section: Part A ‚Äî Platform Numbers -->
            <div class="platform-section">
                <h3>Help us estimate your reach</h3>
                <p class="section-hint">Leave blank if not applicable ‚Äî these help us calculate your publishing potential.</p>
                <div class="platform-grid">
                    <div class="platform-field">
                        <label for="email_list">Email List Size</label>
                        <input type="number" id="email_list" name="email_list" min="0" placeholder="e.g. 5000">
                    </div>
                    <div class="platform-field">
                        <label for="instagram_followers">Instagram Followers</label>
                        <input type="number" id="instagram_followers" name="instagram_followers" min="0" placeholder="e.g. 10000">
                    </div>
                    <div class="platform-field">
                        <label for="linkedin_followers">LinkedIn Followers</label>
                        <input type="number" id="linkedin_followers" name="linkedin_followers" min="0" placeholder="e.g. 2500">
                    </div>
                    <div class="platform-field">
                        <label for="youtube_subscribers">YouTube Subscribers</label>
                        <input type="number" id="youtube_subscribers" name="youtube_subscribers" min="0" placeholder="e.g. 1000">
                    </div>
                    <div class="platform-field">
                        <label for="tiktok_followers">TikTok Followers</label>
                        <input type="number" id="tiktok_followers" name="tiktok_followers" min="0" placeholder="e.g. 8000">
                    </div>
                    <div class="platform-field">
                        <label for="podcast_audience">Podcast Audience</label>
                        <input type="number" id="podcast_audience" name="podcast_audience" min="0" placeholder="e.g. 3000">
                    </div>
                    <div class="platform-field">
                        <label for="speaking_engagements">Speaking Engagements / Year</label>
                        <input type="number" id="speaking_engagements" name="speaking_engagements" min="0" placeholder="e.g. 12">
                    </div>
                    <div class="platform-field">
                        <label for="avg_audience_per_talk">Avg Audience per Talk</label>
                        <input type="number" id="avg_audience_per_talk" name="avg_audience_per_talk" min="0" placeholder="e.g. 200">
                    </div>
                    <div class="platform-field">
                        <label for="bulk_orders">Confirmed Bulk Orders</label>
                        <input type="number" id="bulk_orders" name="bulk_orders" min="0" placeholder="e.g. 500">
                    </div>
                </div>
            </div>
            <!-- Marketing Section: Part B ‚Äî Marketing Strategy -->
            <div class="form-group">
                <label for="marketing_strategy">Your Marketing Strategy</label>
                <p class="form-hint">Describe your PR plan, partnerships, speaking calendar, social media approach, and any other marketing activities.</p>
                <textarea id="marketing_strategy" name="marketing_strategy" rows="6" placeholder="Describe your marketing plan..."></textarea>
            </div>
            <input type="hidden" name="platform_data" id="platform_data_json">
            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="terms_accepted" name="terms_accepted" required>
                    <label for="terms_accepted" class="checkbox-label">
                        I agree to the <a href="#" onclick="document.getElementById('terms-modal').classList.remove('hidden'); return false;">Terms and Conditions</a> *
                    </label>
                </div>
            </div>
            <div class="submit-section">
                <button type="submit" class="btn btn-accent submit-btn">Submit for Evaluation</button>
                <p style="margin-top:1rem;font-size:0.875rem;color:var(--gray-500);">
                    Don't have a full proposal yet?
                    <a href="{{ url_for('coach') }}" style="color:var(--primary);font-weight:600;">Start with our guided proposal builder &#8594;</a>
                </p>
            </div>
        </form>
    </div>
</div>

<section class="what-we-evaluate">
    <div class="container" style="text-align: center;">
        <h2>What We Evaluate</h2>
        <div class="eval-grid">
            <div class="eval-card"><h3>üìñ Concept & Hook</h3><p>Is your book idea compelling and marketable?</p></div>
            <div class="eval-card"><h3>üìä Market Analysis</h3><p>Do you understand your target audience?</p></div>
            <div class="eval-card"><h3>üë§ Author Platform</h3><p>What credentials and audience do you bring?</p></div>
            <div class="eval-card"><h3>‚úçÔ∏è Writing Sample</h3><p>Is your writing engaging and professional?</p></div>
            <div class="eval-card"><h3>üì£ Marketing Plan</h3><p>Do you have a concrete plan to reach readers?</p></div>
            <div class="eval-card"><h3>üìö Competitive Titles</h3><p>How does your book compare to existing titles?</p></div>
        </div>
    </div>
</section>

<div id="terms-modal" class="modal-overlay hidden" onclick="if(event.target===this)this.classList.add('hidden')">
    <div class="modal-content" style="max-height: 80vh; overflow-y: auto;">
        <button class="modal-close" onclick="document.getElementById('terms-modal').classList.add('hidden')">&times;</button>
        <h2>Terms and Conditions</h2>
        <h3>Book Proposal Evaluation Terms and Conditions</h3>
        <p><strong>Effective Date:</strong> Upon submission</p>

        <h4>1. Service Description</h4>
        <p>Write It Great LLC ("Company") provides an AI-assisted book proposal evaluation service. By submitting your proposal, you acknowledge that the evaluation is generated using artificial intelligence technology and is intended as guidance only.</p>

        <h4>2. No Guarantee of Publishing Success</h4>
        <p>The evaluation results do not guarantee publication, representation, or commercial success. The scores and feedback provided are subjective assessments based on industry standards and should be considered as one of many factors in your publishing journey.</p>

        <h4>3. Intellectual Property</h4>
        <p>You retain all rights to your submitted materials. By submitting your proposal, you grant Write It Great LLC a limited license to process and analyze your content solely for the purpose of providing the evaluation service.</p>

        <h4>4. Data Handling</h4>
        <p>Your submitted materials will be processed securely. We do not share your content with third parties except as necessary to provide the evaluation service (e.g., AI processing). Proposal content may be temporarily stored for processing purposes.</p>

        <h4>5. Limitation of Liability</h4>
        <p>Write It Great LLC's liability is limited to the amount paid for the service, if any. We are not liable for any indirect, incidental, or consequential damages arising from use of the evaluation service.</p>

        <h4>6. Accuracy of Information</h4>
        <p>You represent that all information provided is accurate and that you have the right to submit the materials for evaluation.</p>

        <h4>7. Changes to Terms</h4>
        <p>We reserve the right to modify these terms at any time. Continued use of the service constitutes acceptance of modified terms.</p>

        <h4>8. Governing Law</h4>
        <p>These terms are governed by the laws of the State of New York, without regard to conflict of law principles.</p>

        <p style="margin-top: 1.5rem; font-style: italic; color: var(--gray-600);">By checking the agreement box, you acknowledge that you have read, understood, and agree to these Terms and Conditions.</p>
    </div>
</div>


<div id="loading-overlay" class="loading-overlay hidden">
    <div class="spinner"></div>
    <p class="loading-text">Evaluating your proposal...</p>
    <p class="loading-subtext">This may take 30-60 seconds</p>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('proposal-form');
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('proposal_file');
    const uploadText = document.getElementById('upload-text');
    const selectedFile = document.getElementById('selected-file');
    const selectedFilename = document.getElementById('selected-filename');
    const loadingOverlay = document.getElementById('loading-overlay');

    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        if (e.dataTransfer.files.length) { fileInput.files = e.dataTransfer.files; updateFileDisplay(); }
    });
    fileInput.addEventListener('change', updateFileDisplay);

    function updateFileDisplay() {
        if (fileInput.files.length > 0) {
            uploadText.classList.add('hidden');
            selectedFile.classList.remove('hidden');
            selectedFilename.textContent = fileInput.files[0].name;
        }
    }

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const existingError = form.querySelector('.error-message');
        if (existingError) existingError.remove();

        // Serialize Part A platform numbers to JSON before submission
        const parseField = (id) => {
            const val = document.getElementById(id).value.trim();
            return val === '' ? null : parseInt(val, 10);
        };
        document.getElementById('platform_data_json').value = JSON.stringify({
            email_list:            parseField('email_list'),
            instagram_followers:   parseField('instagram_followers'),
            linkedin_followers:    parseField('linkedin_followers'),
            youtube_subscribers:   parseField('youtube_subscribers'),
            tiktok_followers:      parseField('tiktok_followers'),
            podcast_audience:      parseField('podcast_audience'),
            speaking_engagements:  parseField('speaking_engagements'),
            avg_audience_per_talk: parseField('avg_audience_per_talk'),
            bulk_orders:           parseField('bulk_orders')
        });

        loadingOverlay.classList.remove('hidden');

        try {
            const response = await fetch('/api/evaluate', { method: 'POST', body: new FormData(form) });
            const data = await response.json();
            if (data.success && data.proposal_id) {
                {% if current_user.is_authenticated and current_user.is_team_member %}
                window.location.href = '/results/' + data.proposal_id;
                {% else %}
                window.location.href = '/author/proposal/' + data.proposal_id;
                {% endif %}
            } else {
                loadingOverlay.classList.add('hidden');
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.textContent = data.error || 'An error occurred.';
                form.querySelector('.submit-section').before(errorDiv);
            }
        } catch (error) {
            loadingOverlay.classList.add('hidden');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = 'Network error. Please try again.';
            form.querySelector('.submit-section').before(errorDiv);
        }
    });
});
</script>
{% endblock %}
