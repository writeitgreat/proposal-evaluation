{% extends "base.html" %}

{% block title %}Submit Your Book Proposal - Write It Great{% endblock %}

{% block extra_css %}
<style>
    .hero {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
        color: white;
        padding: 4rem 2rem;
        text-align: center;
    }

    .hero h1 {
        color: var(--gold);
        font-size: 2.5rem;
        margin-bottom: 1rem;
    }

    .hero p {
        font-size: 1.125rem;
        opacity: 0.9;
        max-width: 600px;
        margin: 0 auto;
    }

    .form-container {
        max-width: 700px;
        margin: -2rem auto 2rem;
        position: relative;
        z-index: 10;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: var(--gray-700);
    }

    .form-group input,
    .form-group select {
        width: 100%;
        padding: 0.875rem 1rem;
        border: 2px solid var(--gray-200);
        border-radius: var(--radius);
        font-size: 1rem;
        transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: var(--primary);
    }

    .form-hint {
        font-size: 0.875rem;
        color: var(--gray-500);
        margin-top: 0.5rem;
    }

    .upload-zone {
        border: 2px dashed var(--gray-300);
        border-radius: var(--radius);
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
    }

    .upload-zone:hover,
    .upload-zone.dragover {
        border-color: var(--primary);
        background: var(--gray-50);
    }

    .upload-zone svg {
        width: 48px;
        height: 48px;
        color: var(--gray-400);
        margin-bottom: 1rem;
    }

    .upload-zone p {
        color: var(--gray-600);
    }

    .upload-zone .browse-link {
        color: var(--primary);
        font-weight: 600;
    }

    .selected-file {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 1rem;
        background: var(--gray-50);
        border-radius: var(--radius);
    }

    .selected-file svg {
        color: var(--success);
    }

    .hidden {
        display: none !important;
    }

    .submit-section {
        text-align: center;
        padding-top: 1rem;
    }

    .submit-btn {
        width: 100%;
        max-width: 300px;
        padding: 1rem 2rem;
        font-size: 1.125rem;
    }

    .what-we-evaluate {
        background: var(--gray-50);
        padding: 3rem 2rem;
    }

    .eval-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
        max-width: 1000px;
        margin: 2rem auto 0;
    }

    .eval-card {
        background: white;
        padding: 1.5rem;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
    }

    .eval-card h3 {
        font-size: 1rem;
        margin-bottom: 0.5rem;
        color: var(--primary);
    }

    .eval-card p {
        font-size: 0.875rem;
        color: var(--gray-600);
    }

    /* Loading overlay */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(74, 44, 90, 0.95);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        color: white;
    }

    .spinner {
        width: 60px;
        height: 60px;
        border: 4px solid var(--gold-light);
        border-top-color: var(--gold);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 1.5rem;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .loading-text {
        font-size: 1.25rem;
        font-weight: 500;
    }

    .loading-subtext {
        font-size: 0.875rem;
        opacity: 0.8;
        margin-top: 0.5rem;
    }

    .error-message {
        background: #fee2e2;
        color: #991b1b;
        padding: 1rem;
        border-radius: var(--radius);
        margin-bottom: 1rem;
        border: 1px solid #fca5a5;
    }
</style>
{% endblock %}

{% block content %}
<section class="hero">
    <h1>Book Proposal Evaluation</h1>
    <p>Get expert feedback on your book proposal from our team of publishing professionals.</p>
</section>

<div class="container form-container">
    <div class="card">
        <form id="proposal-form" enctype="multipart/form-data">
            <div class="form-group">
                <label for="author_name">Your Full Name *</label>
                <input type="text" id="author_name" name="author_name" required placeholder="John Smith">
            </div>

            <div class="form-group">
                <label for="author_email">Email Address *</label>
                <input type="email" id="author_email" name="author_email" required placeholder="john@example.com">
                <p class="form-hint">We'll send your evaluation report to this email.</p>
            </div>

            <div class="form-group">
                <label for="book_title">Book Title *</label>
                <input type="text" id="book_title" name="book_title" required placeholder="The Art of Writing">
            </div>

            <div class="form-group">
                <label for="proposal_type">Submission Type *</label>
                <select id="proposal_type" name="proposal_type" required>
                    <option value="full">Full Proposal (All Sections)</option>
                    <option value="marketing_only">Marketing Materials Only</option>
                    <option value="no_marketing">Proposal Without Marketing</option>
                </select>
                <p class="form-hint">Select what's included in your document.</p>
            </div>

            <div class="form-group">
                <label>Upload Your Proposal *</label>
                <div class="upload-zone" id="drop-zone">
                    <input type="file" id="proposal_file" name="proposal_file" accept=".pdf,.doc,.docx" required style="display: none;">
                    <div id="upload-text">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                        </svg>
                        <p>Drag and drop your file here, or <span class="browse-link">browse</span></p>
                        <p class="form-hint">PDF, DOC, or DOCX (max 16MB)</p>
                    </div>
                    <div id="selected-file" class="selected-file hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span id="selected-filename"></span>
                    </div>
                </div>
            </div>

            <div class="submit-section">
                <button type="submit" class="btn btn-primary submit-btn">Submit for Evaluation</button>
            </div>
        </form>
    </div>
</div>

<section class="what-we-evaluate">
    <div class="container" style="text-align: center;">
        <h2>What We Evaluate</h2>
        <div class="eval-grid">
            <div class="eval-card">
                <h3>üìñ Concept & Hook</h3>
                <p>Is your book idea compelling and marketable? Does it fill a gap in the market?</p>
            </div>
            <div class="eval-card">
                <h3>üìä Market Analysis</h3>
                <p>Do you understand your target audience? Is your competitive analysis thorough?</p>
            </div>
            <div class="eval-card">
                <h3>üë§ Author Platform</h3>
                <p>What credentials and audience do you bring? Can you help promote the book?</p>
            </div>
            <div class="eval-card">
                <h3>‚úçÔ∏è Writing Sample</h3>
                <p>Is your writing engaging and professional? Does it match the book's tone?</p>
            </div>
            <div class="eval-card">
                <h3>üì£ Marketing Plan</h3>
                <p>Do you have a concrete plan to reach readers? What assets can you leverage?</p>
            </div>
            <div class="eval-card">
                <h3>üìö Competitive Titles</h3>
                <p>How does your book compare to existing titles? What makes it unique?</p>
            </div>
        </div>
    </div>
</section>

<div id="loading-overlay" class="loading-overlay hidden">
    <div class="spinner"></div>
    <p class="loading-text">Evaluating your proposal...</p>
    <p class="loading-subtext">This may take 30-60 seconds</p>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('proposal-form');
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('proposal_file');
    const uploadText = document.getElementById('upload-text');
    const selectedFile = document.getElementById('selected-file');
    const selectedFilename = document.getElementById('selected-filename');
    const loadingOverlay = document.getElementById('loading-overlay');

    // File upload handling
    dropZone.addEventListener('click', () => fileInput.click());
    
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        if (e.dataTransfer.files.length) {
            fileInput.files = e.dataTransfer.files;
            updateFileDisplay();
        }
    });

    fileInput.addEventListener('change', updateFileDisplay);

    function updateFileDisplay() {
        if (fileInput.files.length > 0) {
            uploadText.classList.add('hidden');
            selectedFile.classList.remove('hidden');
            selectedFilename.textContent = fileInput.files[0].name;
        } else {
            uploadText.classList.remove('hidden');
            selectedFile.classList.add('hidden');
        }
    }

    // Form submission
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Remove existing errors
        const existingError = form.querySelector('.error-message');
        if (existingError) existingError.remove();
        
        loadingOverlay.classList.remove('hidden');
        
        const formData = new FormData(form);
        
        try {
            const response = await fetch('/api/evaluate', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            console.log('API Response:', data);
            
            if (data.success && data.proposal_id) {
                window.location.href = '/results/' + data.proposal_id;
            } else {
                loadingOverlay.classList.add('hidden');
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.textContent = data.error || 'An error occurred. Please try again.';
                form.querySelector('.submit-section').before(errorDiv);
            }
        } catch (error) {
            console.error('Fetch error:', error);
            loadingOverlay.classList.add('hidden');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = 'Network error. Please try again.';
            form.querySelector('.submit-section').before(errorDiv);
        }
    });
});
</script>
{% endblock %}
