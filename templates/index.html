{% extends "base.html" %}
{% block title %}Submit Your Book Proposal - Write It Great{% endblock %}
{% block content %}
<section class="hero">
    <h1>Book Proposal Evaluation</h1>
    <p>Get expert feedback on your book proposal from our team of publishing professionals.</p>
</section>

<div class="container form-container">
    <div class="card">
        <form id="proposal-form" enctype="multipart/form-data">
            <div class="form-group">
                <label for="author_name">Your Full Name *</label>
                <input type="text" id="author_name" name="author_name" required placeholder="John Smith">
            </div>
            <div class="form-group">
                <label for="author_email">Email Address *</label>
                <input type="email" id="author_email" name="author_email" required placeholder="john@example.com">
                <p class="form-hint">We'll send your evaluation report to this email.</p>
            </div>
            <div class="form-group">
                <label for="book_title">Book Title *</label>
                <input type="text" id="book_title" name="book_title" required placeholder="The Art of Writing">
            </div>
            <div class="form-group">
                <label for="proposal_type">Submission Type *</label>
                <select id="proposal_type" name="proposal_type" required>
                    <option value="full">Full Proposal (All Sections)</option>
                    <option value="marketing_only">Marketing Materials Only</option>
                    <option value="no_marketing">Proposal Without Marketing</option>
                </select>
            </div>
            <div class="form-group">
                <label>Upload Your Proposal *</label>
                <div class="upload-zone" id="drop-zone">
                    <input type="file" id="proposal_file" name="proposal_file" accept=".pdf,.doc,.docx" required style="display: none;">
                    <div id="upload-text">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                        </svg>
                        <p>Drag and drop your file here, or <span class="browse-link">browse</span></p>
                        <p class="form-hint">PDF, DOC, or DOCX (max 16MB)</p>
                    </div>
                    <div id="selected-file" class="selected-file hidden">
                        <svg width="24" height="24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        <span id="selected-filename"></span>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="terms_accepted" name="terms_accepted" required>
                    <label for="terms_accepted" class="checkbox-label">
                        I agree to the <a href="#" onclick="document.getElementById('terms-modal').classList.remove('hidden'); return false;">Terms & Conditions</a> and confirm that I have the right to submit this work.
                    </label>
                </div>
            </div>
            <div class="submit-section">
                <button type="submit" class="btn btn-primary submit-btn">Submit for Evaluation</button>
            </div>
        </form>
    </div>
</div>

<section class="what-we-evaluate">
    <div class="container" style="text-align: center;">
        <h2>What We Evaluate</h2>
        <div class="eval-grid">
            <div class="eval-card"><h3>üìñ Concept & Hook</h3><p>Is your book idea compelling and marketable?</p></div>
            <div class="eval-card"><h3>üìä Market Analysis</h3><p>Do you understand your target audience?</p></div>
            <div class="eval-card"><h3>üë§ Author Platform</h3><p>What credentials and audience do you bring?</p></div>
            <div class="eval-card"><h3>‚úçÔ∏è Writing Sample</h3><p>Is your writing engaging and professional?</p></div>
            <div class="eval-card"><h3>üì£ Marketing Plan</h3><p>Do you have a concrete plan to reach readers?</p></div>
            <div class="eval-card"><h3>üìö Competitive Titles</h3><p>How does your book compare to existing titles?</p></div>
        </div>
    </div>
</section>

<div id="terms-modal" class="modal-overlay hidden" onclick="if(event.target===this)this.classList.add('hidden')">
    <div class="modal-content">
        <button class="modal-close" onclick="document.getElementById('terms-modal').classList.add('hidden')">&times;</button>
        <h2>Terms & Conditions</h2>
        <p><strong>1. Ownership:</strong> You confirm you are the original author and have rights to submit this work.</p>
        <p><strong>2. Confidentiality:</strong> We treat all submissions as confidential.</p>
        <p><strong>3. Evaluation Purpose:</strong> The evaluation is for informational purposes only.</p>
        <p><strong>4. Data Storage:</strong> Your submission will be stored securely.</p>
        <p><strong>5. No Obligation:</strong> Submitting does not obligate either party.</p>
    </div>
</div>

<div id="loading-overlay" class="loading-overlay hidden">
    <div class="spinner"></div>
    <p class="loading-text">Evaluating your proposal...</p>
    <p class="loading-subtext">This may take 30-60 seconds</p>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('proposal-form');
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('proposal_file');
    const uploadText = document.getElementById('upload-text');
    const selectedFile = document.getElementById('selected-file');
    const selectedFilename = document.getElementById('selected-filename');
    const loadingOverlay = document.getElementById('loading-overlay');

    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        if (e.dataTransfer.files.length) { fileInput.files = e.dataTransfer.files; updateFileDisplay(); }
    });
    fileInput.addEventListener('change', updateFileDisplay);

    function updateFileDisplay() {
        if (fileInput.files.length > 0) {
            uploadText.classList.add('hidden');
            selectedFile.classList.remove('hidden');
            selectedFilename.textContent = fileInput.files[0].name;
        }
    }

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const existingError = form.querySelector('.error-message');
        if (existingError) existingError.remove();
        loadingOverlay.classList.remove('hidden');
        
        try {
            const response = await fetch('/api/evaluate', { method: 'POST', body: new FormData(form) });
            const data = await response.json();
            if (data.success && data.proposal_id) {
                window.location.href = '/results/' + data.proposal_id;
            } else {
                loadingOverlay.classList.add('hidden');
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.textContent = data.error || 'An error occurred.';
                form.querySelector('.submit-section').before(errorDiv);
            }
        } catch (error) {
            loadingOverlay.classList.add('hidden');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = 'Network error. Please try again.';
            form.querySelector('.submit-section').before(errorDiv);
        }
    });
});
</script>
{% endblock %}
