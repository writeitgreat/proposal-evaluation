{% extends "base.html" %}
{% block title %}Proposal Text - {{ proposal.book_title }}{% endblock %}
{% block extra_css %}
.proposal-content h1 { font-size: 1.5rem; font-weight: 700; color: var(--primary); margin: 1.5rem 0 0.75rem; }
.proposal-content h2 { font-size: 1.25rem; font-weight: 700; color: var(--primary); margin: 1.5rem 0 0.5rem; border-bottom: 2px solid var(--accent); padding-bottom: 0.375rem; }
.proposal-content h3 { font-size: 1.1rem; font-weight: 600; color: var(--gray-800); margin: 1.25rem 0 0.5rem; }
.proposal-content h4 { font-size: 1rem; font-weight: 600; color: var(--gray-700); margin: 1rem 0 0.375rem; }
.proposal-content p { margin: 0.5rem 0; line-height: 1.8; color: var(--gray-800); }
.proposal-content ul { margin: 0.5rem 0 0.5rem 1.5rem; }
.proposal-content li { margin: 0.25rem 0; line-height: 1.7; color: var(--gray-800); }
.proposal-content br { display: block; content: ""; margin: 0.25rem 0; }
.proposal-content strong { color: var(--gray-900); }
.pdf-embed { width: 100%; height: 80vh; border: none; border-radius: var(--radius); }
{% endblock %}
{% block content %}
<section class="proposal-header">
    <div class="container">
        <h1>{{ proposal.book_title }}</h1>
        <div class="proposal-meta">
            <span>{{ proposal.author_name }}</span>
            <span>{{ proposal.submission_id }}</span>
            <span>{{ proposal.submitted_at.strftime('%B %d, %Y') if proposal.submitted_at else 'N/A' }}</span>
        </div>
    </div>
</section>

<div class="container" style="max-width: 900px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <a href="{{ url_for('admin_proposal_detail', submission_id=proposal.submission_id) }}" class="btn btn-outline" style="padding: 0.5rem 1rem;">&larr; Back to Evaluation</a>
        <a href="{{ url_for('download_proposal_text', submission_id=proposal.submission_id) }}" class="btn btn-accent" style="padding: 0.5rem 1rem;">Download Original</a>
    </div>

    <div class="card">
        <h3 style="margin-bottom: 1rem; color: var(--primary);">Original Submitted Proposal</h3>

        {% if embed_pdf %}
        {# PDF: use browser's built-in PDF viewer #}
        <iframe src="{{ url_for('embed_proposal_file', submission_id=proposal.submission_id) }}" class="pdf-embed"></iframe>

        {% elif formatted_html %}
        {# DOCX: rendered as formatted HTML #}
        <div class="proposal-content">
            {{ formatted_html|safe }}
        </div>

        {% elif proposal.proposal_text %}
        {# Plain text fallback: add basic formatting #}
        <div class="proposal-content">
            {% for line in proposal.proposal_text.split('\n') %}
                {% if line.strip() == '' %}
                    <br>
                {% elif line.strip()|length < 60 and line.strip() == line.strip()|upper %}
                    <h2>{{ line.strip() }}</h2>
                {% elif line.strip()|length < 80 and line.strip().endswith(':') %}
                    <h3>{{ line.strip() }}</h3>
                {% elif line.strip().startswith('•') or line.strip().startswith('-') or line.strip().startswith('*') %}
                    <li style="margin-left: 1.5rem;">{{ line.strip().lstrip('•-* ') }}</li>
                {% else %}
                    <p>{{ line }}</p>
                {% endif %}
            {% endfor %}
        </div>

        {% else %}
        <p style="color: var(--gray-500); text-align: center; padding: 2rem;">No proposal text available for this submission.</p>
        {% endif %}
    </div>
</div>
{% endblock %}
